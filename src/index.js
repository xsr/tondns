import lodash from "lodash"
import React from "react"
import axios from "axios"
import dayjs from "dayjs"
import TonWeb from "tonweb"

export const
  DDNS_DNS = "B5EE9C7241022E010005A1000114FF00F4A413F4BCF2C80B0102016202030202CB04050201201C1D02012006070201621A1B02012008090031DFC237C22FC227C21E47C20E78B7C21678B6666666664F6AA40201480A0B020120161704DF0C8871C02497C0F83434C0C05C6C2497C0F83E903E900C7E800C5C75C87E800C7E800C3C01FC01A3854C1B04BE1071C17CB8647E90007E18B50C3E18FC023840B4C7F4CFC8A08417F30F452EA3A28C80BE10B1C17CB864563808A0840BF2C9A8AEB8C088A044446EB8C088A041DDEEA00C0D0E0F00113E910C30003CB8536002F401FA4021F001FA40D20031FA0006820AFAF080A121945314A0A1DE22D70B01C300209205A19135E220C2FFF2E192218E3D821005138D91C8F842CF165008CF1671250449135448A0708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00923630E202926C31E30DF8621415008630316C227082108B7717358201FDE8ED43D8C8CBFFF841CF1641308040708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00006E30316C2270811112F006C8CBFF41308040708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB0004FC8E10355B31F842C705F2E191D430F864F008E022810999BA8EB40370F833D0D70BFF01FA4401C0FF02BAB0F2E19102D31F312182105FCC3D14BA93346C21E30D810777BA96D430F864F0089130E2E03434208210693D3950BAE3023322810888BA8E116C12F842C705F2E191D4FA00FA4030F010E03001810889BAE302301011121302FE4440520401FA4021F001FA40D20031FA0006820AFAF080A121945314A0A1DE22D70B01C300209205A19135E220C2FFF2E192218E3D821005138D91C8F842CF165008CF1671250449135448A0708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00923630E202926C31E30DF86201141500503031018210A8CB00AD708010C8CB055004CF1623FA0213CB6A12CB1FCB3FF846D0CF16C98040FB0000607001D48E28018040F4966FA531208E1804A4208100FABE93F2C18FDE03D402FA00FA4030F01040139131E2B312E65F030008840FF2F0006A21F00141308210D53276DB50046D71708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB000004F008001B5F9007074C8CB02CA07CBFFC9D080201201819000F3E10B5D27000ACE0004F3B51343E90007E187E90007E18BC01A535007E18E520C1F5C878B5007E1935007E1975007E19B460029F422D0F902F828F845888870C85005CF1614CB0114CBFF13CC5220CCCCC97020C8CB0113F400F400CB00C920F005768018C8CB0558CF1624FA02CB6BCC01CF1612CC01C0009280409170E201C901FB00824250061470216D708E1E04D307019E3422AA0212D7183178D7217F5024DF03A423D749B325B11415E633029132E05B840FF2F02080201201E1F02012026270007B8B5D3180201202021001DB5DAFE00FF08DA1A61FA61FF48061002012022230259B1E8FC01FE0A3E1162221C32140173C58532C04532FFC4F314883333325C083232C044FD003D0032C0327C01602425025DB032FC01FE40BE0A3E1162221C32140173C58532C04532FFC4F314883333325C083232C044FD003D0032C0327C0160242500000009000000012002014828290201202A2B0025B3F3FC01DFE0807F7A3B50F63E107E10BE11200013B016FC01DFFE113E10A0000DB4C1FE00FE00D00201202C2D00F7B0C33C01C07C04BE10F4148431C17CB915C875D263870CBC048C0075D2698220802EA4F232C3C0A0805C32FB50F604B3C5B2780C407000638F7E113434C1C070003CB9D4350C20BC246B1271A5D208C839525BCB94B8DB31C1C2E57F084C26FCF694A0FF1F281EB3C060C1FD03FCB9D44075D2698200780C1CF23260001DB37A3E10DBA4BC01F7BE10F43E40A0740458FD",
  DDNS_OWNER = "B5EE9C7241025301000A77000114FF00F4A413F4BCF2C80B0102016202030202CC04050011A13463E00DE011E00B02012006070201480C0D00A5D19916380492F81F068698180B8D8492F81F078037D201801698FE99F9140A2CC5D4FEA7D2002C1044C4B405E79703DF80549199871410404491A5D47096A10F804780289E382F9705E80FD20187805C8ADF1402012008090201200A0B00114ED44D0FA4030F8618003B1C3232801400F3C58073C5A2C0B3C5B25C083232C044FD003D0032C03260001B3E401C1D3232C0B281F2FFF2742004594D0F902F84188888870C85005CF1614CB0114CBFF13CC5220CCCCC97020C8CB0113F400F400CB00C9F005F82880E494A0F02012024250114FF00F4A413F4BCF2C80B2601088812F004100114FF00F4A413F4BCF2C80B1102016212130202CC14150029A0BEABE003F083F085F087F089F08BF08DF08FE007020120161701D9B50041AE43A63FA67E6043022223751CA263F086258E0BE5C3230410989680E5F605F08802E10421AA64EDB6B0DB060CE1003191960AA00F9E2CA00BF4042B96D425963F967E44DD6728B19E2E032265C4039203F600FFF0C31605F0C8E1F0CBE005C003041011246975C604B72302012018190015D642C678B00FD0164FC3440201201A1B020120212203F50CC8B1C02497C0F83434C0FE900C3C00405C6C250C407C02B800B4C7F4CFC8A051662EB8C08C08604444AEA38F5B087E10C4B1C17CB8647E11005C20805166161B6040281C20063232C15401F3C594017E808572DA84B2C7F2CFC89BACE51633C5C0644CB88072407EC0383E107CB875C86080515E2EB8C08CCC601C1D1E006D3B51343480007E187E90007E18BE90007E18FE90007E193E106CFE1135D27000AC244C3834CFC07E1974C7C07E19B5007E19F50C3E1A2002B86C22F841F84214C705B313B1F844D749C202B102FA4001F864028E3331F844017082014598586D8040708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00E0F865D430F86770F86688F868491F01D0310182084C4B40A1F003208E3D5320BCF2E3CDF846F823B609F8668208914578F8236D70708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB008E125B20821005F5E100BCF2E3D0F823A614F866E25220F00482014578012000AC813252BA8E4DF846C200F846F823B9B0F2E3D1F00330F84758F84270820808923404C8CC5005CF161443308306708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB009130E20066F84370811111F8236D8040708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00F002006082081E8480596D72708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00F00200453E123E11FE11BE117E107232803E10B3C5BE10F3C5BE1133C5B2CFF2C7F333327B552000233E12340835D2650C22C09C387E903E800C20007AF84212C705F2E191F0033001708208789234586D8100A0708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB000053087C02083C016051661DA0063232C15400F3C59C3E8084B2DAC4B332C7C4F2CFD633C5B33260103EC02000513E08E042221C20043232C17E1073C5A082E4E1C03E80B2DAB2C7F2CFC4B31C3E808073C5B25C7EC02002016227280202CB292A02012041420201202B2C0201623F400201202D2E0031DFC237C22FC227C21E47C20E78B7C21678B6666666664F6AA40201482F300201203B3C04DF0C8871C02497C0F83434C0C05C6C2497C0F83E903E900C7E800C5C75C87E800C7E800C3C01FC01A3854C1B04BE1071C17CB8647E90007E18B50C3E18FC023840B4C7F4CFC8A08417F30F452EA3A28C80BE10B1C17CB864563808A0840BF2C9A8AEB8C088A044446EB8C088A041DDEEA03132333400113E910C30003CB8536002F401FA4021F001FA40D20031FA0006820AFAF080A121945314A0A1DE22D70B01C300209205A19135E220C2FFF2E192218E3D821005138D91C8F842CF165008CF1671250449135448A0708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00923630E202926C31E30DF862393A008630316C227082108B7717358201FDE8ED43D8C8CBFFF841CF1641308040708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00006E30316C2270811112F006C8CBFF41308040708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB0004FC8E10355B31F842C705F2E191D430F864F008E022810999BA8EB40370F833D0D70BFF01FA4401C0FF02BAB0F2E19102D31F312182105FCC3D14BA93346C21E30D810777BA96D430F864F0089130E2E03434208210693D3950BAE3023322810888BA8E116C12F842C705F2E191D4FA00FA4030F010E03001810889BAE302303536373802FE4440520401FA4021F001FA40D20031FA0006820AFAF080A121945314A0A1DE22D70B01C300209205A19135E220C2FFF2E192218E3D821005138D91C8F842CF165008CF1671250449135448A0708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00923630E202926C31E30DF86201393A00503031018210A8CB00AD708010C8CB055004CF1623FA0213CB6A12CB1FCB3FF846D0CF16C98040FB0000607001D48E28018040F4966FA531208E1804A4208100FABE93F2C18FDE03D402FA00FA4030F01040139131E2B312E65F030008840FF2F0006A21F00141308210D53276DB50046D71708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB000004F008001B5F9007074C8CB02CA07CBFFC9D080201203D3E000F3E10B5D27000ACE0004F3B51343E90007E187E90007E18BC01A535007E18E520C1F5C878B5007E1935007E1975007E19B460029F422D0F902F828F845888870C85005CF1614CB0114CBFF13CC5220CCCCC97020C8CB0113F400F400CB00C920F005768018C8CB0558CF1624FA02CB6BCC01CF1612CC01C0009280409170E201C901FB008494A0061470216D708E1E04D307019E3422AA0212D7183178D7217F5024DF03A423D749B325B11415E633029132E05B840FF2F020802012043440201204B4C0007B8B5D3180201204546001DB5DAFE00FF08DA1A61FA61FF48061002012047480259B1E8FC01FE0A3E1162221C32140173C58532C04532FFC4F314883333325C083232C044FD003D0032C0327C0160494A025DB032FC01FE40BE0A3E1162221C32140173C58532C04532FFC4F314883333325C083232C044FD003D0032C0327C0160494A0000000900000001200201484D4E0201204F500025B3F3FC01DFE0807F7A3B50F63E107E10BE11200013B016FC01DFFE113E10A0000DB4C1FE00FE00D0020120515200F7B0C33C01C07C04BE10F4148431C17CB915C875D263870CBC048C0075D2698220802EA4F232C3C0A0805C32FB50F604B3C5B2780C407000638F7E113434C1C070003CB9D4350C20BC246B1271A5D208C839525BCB94B8DB31C1C2E57F084C26FCF694A0FF1F281EB3C060C1FD03FCB9D44075D2698200780C1CF23260001DB37A3E10DBA4BC01F7BE10F43E40A010E3306A",
  DDNS_AUCTION = "B5EE9C724102150100037C000114FF00F4A413F4BCF2C80B0102016202030202CC04050029A0BEABE003F083F085F087F089F08BF08DF08FE007020120060701D9B50041AE43A63FA67E6043022223751CA263F086258E0BE5C3230410989680E5F605F08802E10421AA64EDB6B0DB060CE1003191960AA00F9E2CA00BF4042B96D425963F967E44DD6728B19E2E032265C4039203F600FFF0C31605F0C8E1F0CBE005C003041011246975C604B71402012008090015D642C678B00FD0164FC3440201200A0B020120121303F50CC8B1C02497C0F83434C0FE900C3C00405C6C250C407C02B800B4C7F4CFC8A051662EB8C08C08604444AEA38F5B087E10C4B1C17CB8647E11005C20805166161B6040281C20063232C15401F3C594017E808572DA84B2C7F2CFC89BACE51633C5C0644CB88072407EC0383E107CB875C86080515E2EB8C08CCC600C0D0E006D3B51343480007E187E90007E18BE90007E18FE90007E193E106CFE1135D27000AC244C3834CFC07E1974C7C07E19B5007E19F50C3E1A2002B86C22F841F84214C705B313B1F844D749C202B102FA4001F864028E3331F844017082014598586D8040708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00E0F865D430F86770F86688F8680F1001D0310182084C4B40A1F003208E3D5320BCF2E3CDF846F823B609F8668208914578F8236D70708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB008E125B20821005F5E100BCF2E3D0F823A614F866E25220F00482014578011100AC813252BA8E4DF846C200F846F823B9B0F2E3D1F00330F84758F84270820808923404C8CC5005CF161443308306708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB009130E200000066F84370811111F8236D8040708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00F002006082081E8480596D72708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00F00200453E123E11FE11BE117E107232803E10B3C5BE10F3C5BE1133C5B2CFF2C7F333327B552000233E12340835D2650C22C09C387E903E800C20007AF84212C705F2E191F0033001708208789234586D8100A0708018C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB001823F64B",
  api = axios.create({baseURL: location.origin}),
  ton = new TonWeb.HttpProvider("https://testnet.toncenter.com/api/v2/jsonRPC", {apiKey: "5c7c4d700f4e5aa33696920635ed1bdd82873547411d18f82097053821aeeb00"}),
  readIntFromBitString = (bs, cursor, bits) => {
    let n = BigInt(0)
    for (let i = 0; i < bits; i++) {
        n *= BigInt(2)
        n += BigInt(bs.get(cursor + i))
    }
    return n
  },
  parseAddress = cell => {
    let n = readIntFromBitString(cell.bits, 3, 8)
    if (n > BigInt(127)) {
        n = n - BigInt(256)
    }
    const hashPart = readIntFromBitString(cell.bits, 3 + 8, 256)
    if (n.toString(10) + ":" + hashPart.toString(16) === '0:0') return null
    const s = n.toString(10) + ":" + hashPart.toString(16).padStart(64, '0')
    return new TonWeb.Address(s)
  },
  DDNS = class extends TonWeb.Contract {
    constructor(address) {
      super(ton, {
        address: new TonWeb.Address(address),
        code: TonWeb.boc.Cell.oneFromBoc(DDNS_DNS)
      })
    }
    async getNftAddressByName(name) {
      let
        cell = new TonWeb.boc.Cell(),
        data
      cell.bits.writeString(name)
      data = await this.provider.call2((await this.getAddress()).toString(), "get_nft_address_by_name", [["tvm.Slice", TonWeb.utils.bytesToBase64(await cell.toBoc(false))]])
      return parseAddress(data)
    }
    async isInit() {
      let data = await this.provider.call2((await this.getAddress()).toString(), "is_init")
      return data.toNumber()
    }
    async getNftData() {
      let data = await this.provider.call2((await this.getAddress()).toString(), "get_nft_data")
      return {
        index: data[1].toNumber(),
        collectionAddress: parseAddress(data[2]),
        ownerAddress: parseAddress(data[3]),
        contentCell: data[4]
      }
    }
    async getCollectionData() {
      let data = await this.provider.call2((await this.getAddress()).toString(), "get_collection_data")
      return {
        nextItemIndex: data[0].toNumber(),
        ownerAddress: parseAddress(data[2])
      }
    }
  },
  Auction = class extends TonWeb.Contract {
  },
  DDNSOwner = class extends TonWeb.Contract {
    constructor(address) {
      super(ton, {
        address: new TonWeb.Address(address),
        code: TonWeb.boc.Cell.oneFromBoc(DDNS_OWNER)
      })
      this.methods.getAuctionAddress = this.getAuctionAddress.bind(this)
    }
    async getAddressInfo(address) {
      return this.provider.getAddressInfo(address)
    }
    async getAuctionAddress(domain) {
      const
        me = await this.getAddress(),
        cell = new TonWeb.boc.Cell()
      cell.bits.writeString(domain)
      let
        data = await this.provider.call2(me.toString(), "get_auction_address", [["tvm.Cell", TonWeb.utils.bytesToBase64(await cell.toBoc(false))]])
      // console.log("dat", data.bits.toString())
      return parseAddress(data)
    }
    async deployAuction(domain) {

      const accs = await window.ton.send("ton_requestAccounts")
      const wals = await window.ton.send("ton_requestWallets")
      console.log("accs", accs)
      console.log("wal", wals)

      let
        ret,
        domainCell = new TonWeb.boc.Cell(),
        cell = new TonWeb.boc.Cell()

      domainCell.bits.writeString(domain)

      cell.bits.writeUint(0x4598, 32)
      cell.bits.writeUint(new Date().getTime(), 64)
      cell.bits.writeAddress(new TonWeb.Address(accs[0]))
      cell.refs[0] = domainCell


      ret = await window.ton.send(
        "ton_sendTransaction",
        [{
          to: (await this.getAddress()).toString(),
          // to: "0QDbvAbsX5SSrEJxuHeYJ1xjynTrR5er-XFsC1FMJZOZK6L8",
          value: "280000000",
          dataType: "boc",
          data: TonWeb.utils.bytesToBase64(await cell.toBoc(false)),
        }]
      )

      // let
      //   ret = await this.provider.call2(
      //     (await this.getAddress()).toString(),
      //     "deploy_auction",
      //     [
      //       ["num", new Date().getTime()],
      //       ["tvm.Cell", TonWeb.utils.bytesToBase64(await domainCell.toBoc(false))],
      //       ["tvm.Slice", TonWeb.utils.bytesToBase64(await destinationCell.toBoc(false))]
      //     ]
      //   )
      // let
      //   ret = await window.ton.send(
      //     "runGetMethod", {
      //       address: (await this.getAddress()).toString(),
      //       method: "deploy_auction",
      //       params: [
      //         ["num", new Date().getTime()],
      //         ["tvm.Cell", TonWeb.utils.bytesToBase64(await domainCell.toBoc(false))],
      //         ["tvm.Slice", TonWeb.utils.bytesToBase64(await destinationCell.toBoc(false))]
      //       ]
      //     }
      //   )
      return ret
    }
  },
  useDDNS = (address) => {
    const
      contract = new DDNS(address),
      info = async address => {
        return await ton.getAddressInfo(address)
      }
    return {contract, info}
  },
  useDNSOwner = (address) => {
    const
      contract = new DDNSOwner(address)
    return {
      contract
    }
  },
  nil = null
